<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="es">
<head th:replace="~{layout :: head('Mapa de Rutas')}"></head>
<body>
  <header th:replace="~{layout :: header}"></header>

  <main class="main">
    <div class="card">
      <div class="card-header" style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
        <h2 style="margin:0;">Mapa de Rutas (punto a punto)</h2>
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
          <label style="font-size:14px;color:var(--muted)">Criterio:</label>
          <select id="criterio" class="btn" style="padding:8px 10px;">
            <option value="nn">Más cercano (greedy)</option>
            <option value="lat">Ordenar por latitud</option>
          </select>
          <button id="recalcular" class="btn primary">Recalcular ruta</button>
        </div>
      </div>
      <div class="card-body">
        <div id="map" style="height:520px;width:100%;border-radius:10px;border:1px solid var(--border);"></div>
        <div style="margin-top:12px;display:flex;gap:16px;flex-wrap:wrap;">
          <div><strong>Total puntos:</strong> <span id="totalPuntos">0</span></div>
          <div><strong>Distancia estimada (km):</strong> <span id="distKm">0.00</span></div>
          <div><strong>Orden:</strong> <span id="orden"></span></div>
        </div>
      </div>
    </div>
  </main>

  <footer th:replace="~{layout :: footer}"></footer>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-30.9064, -55.5508], 12); // Rivera por defecto
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    const markersLayer = L.layerGroup().addTo(map);
    let puntos = []; // {id, descripcion, lat, lng}
    let polyline;    // ruta dibujada

    async function cargarPuntos() {
      const res = await fetch('/api/rutas/solicitudes');
      const data = await res.json();
      // normalizar
      puntos = data.map(d => ({ id: d.id, descripcion: d.descripcion, lat: d.lat, lng: d.lng }));
      document.getElementById('totalPuntos').textContent = puntos.length;
      dibujarPuntos();
      calcularYdibujarRuta();
    }

    function dibujarPuntos() {
      markersLayer.clearLayers();
      if (!puntos.length) return;
      const bounds = [];
      puntos.forEach(p => {
        const m = L.marker([p.lat, p.lng]).bindPopup(`#${p.id} - ${p.descripcion ?? ''}`);
        m.addTo(markersLayer);
        bounds.push([p.lat, p.lng]);
      });
      if (bounds.length) map.fitBounds(bounds, { padding: [20, 20] });
    }

    function haversine(a, b) {
      const R = 6371; // km
      const dLat = (b.lat - a.lat) * Math.PI / 180;
      const dLng = (b.lng - a.lng) * Math.PI / 180;
      const la1 = a.lat * Math.PI / 180;
      const la2 = b.lat * Math.PI / 180;
      const sinDLat = Math.sin(dLat/2), sinDLng = Math.sin(dLng/2);
      const h = sinDLat*sinDLat + Math.cos(la1)*Math.cos(la2)*sinDLng*sinDLng;
      return 2 * R * Math.asin(Math.sqrt(h));
    }

    function rutaNearestNeighbor(origen, pts) {
      // origen puede ser null → usar el primer punto
      const restantes = pts.slice();
      const ruta = [];
      let actual = origen ?? restantes.shift();
      if (!actual) return [];
      if (!origen) ruta.push(actual);
      while (restantes.length) {
        let bestIdx = 0, bestDist = Infinity;
        for (let i = 0; i < restantes.length; i++) {
          const d = haversine(actual, restantes[i]);
          if (d < bestDist) { bestDist = d; bestIdx = i; }
        }
        actual = restantes.splice(bestIdx, 1)[0];
        ruta.push(actual);
      }
      return ruta;
    }

    function calcularRuta(criterio) {
      if (criterio === 'lat') {
        return puntos.slice().sort((a,b) => a.lat - b.lat);
      }
      // default NN empezando en el punto más al norte (lat más alta)
      if (!puntos.length) return [];
      const start = puntos.slice().sort((a,b) => b.lat - a.lat)[0];
      const restantes = puntos.filter(p => p !== start);
      return rutaNearestNeighbor(start, restantes);
    }

    function calcularDistanciaTotal(orden) {
      let total = 0;
      for (let i = 1; i < orden.length; i++) total += haversine(orden[i-1], orden[i]);
      return total;
    }

    function dibujarRuta(orden) {
      if (polyline) { map.removeLayer(polyline); polyline = null; }
      if (!orden.length) return;
      polyline = L.polyline(orden.map(p => [p.lat, p.lng]), { color: '#16a34a', weight: 4 }).addTo(map);
    }

    function calcularYdibujarRuta() {
      const criterio = document.getElementById('criterio').value;
      const orden = calcularRuta(criterio);
      dibujarRuta(orden);
      const km = calcularDistanciaTotal(orden);
      document.getElementById('distKm').textContent = km.toFixed(2);
      document.getElementById('orden').textContent = orden.map(p => `#${p.id}`).join(' → ');
    }

    document.getElementById('recalcular').addEventListener('click', calcularYdibujarRuta);

    cargarPuntos();
  </script>
</body>
</html>
